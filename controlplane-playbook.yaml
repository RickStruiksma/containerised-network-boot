---
- name: configure k8s controlplane
  hosts: controlplane
  become: yes
  tasks:
    - name: create /etc/modules-load.d/containerd.conf
      file: /etc/modules-load.d/containerd.conf
      state: file
    - name: set containerd.conf kernel modules
      copy:
        content: |
                overlay
                br_netfilter
    - name: run modprobe to activate new modules
      command: modprobe overlay br_netfilter
    - name: create etc/sysctl.d/99-kubernetes-cri.conf
      file:
        path: /etc/sysctl.d/99-kubernetes-cri.conf
        state: file
    - name: copy kubernetes-cri settings
      copy:
        path: /etc/sysctl.d/99-kubernetes-cri.conf
        content: |
                net.bridge.bridge-nf-call-iptables = 1
                net.ipv4.ip_forward = 1
                net.bridge.bridge-nf-call-ip6tables = 1
    - name: rerun sysctl to pick up changes
      command: sysctl --system
    - name: install containerd
      yum:
        name: containerd
        state: latest
    - name: create /etc/containerd directory
      file:
        path: /etc/containerd
        state: directory
    - name: create /etc/containerd.config.toml
      file:
        path: /etc/containerd.config.toml
        state: file
    - name: create containerd default config
      command: containerd config default
      register: containerd_config   
    - name: copy containerd config to file
      template:
        src: ./containerd_config
        dest: /etc/containerd.config.toml
    - name: restart containerd
      service:
        name: containerd
        state: restarted
        enabled: yes
    - name: turn off swap
      command: swapoff -a
    - name: configure k8s repository
      copy:
        content: |
                [kubernetes]
                name=Kubernetes
                baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\x86_64
                enabled=1
                gpgcheck=1
                gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
                exclude=kubelet kubeadm kubectl
    - name: intall kubeadm cluster packages
      yum:
        name: {{ "item" }}
      loop: - kubelet
            - kubeadm
            - kubectl
    - name: start and enable kubelet
      service:
        name: kubelet
        state: started
        enabled: yes
    - name: initialize cluster
      command: kubeadm init --pod-network-cidr 192.168.0.0/16 --kubernetes-version=
    - name: create .kube dir in usee home
      file:
        path: /home/kube/.kube
        state: directory
    - name: copy kubernetes admin conf to .kube
      copy:
       src: /etc/kubernetes/admin.conf
       dest: /home/kube/.kube/config
       owner: kube
       group: kube
    - name: install calico networking plugin
      command: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
